trigger:
  - master

pool:
  vmImage: "windows-latest"

variables:
  GRADLE_USER_HOME: $(Pipeline.Workspace)/.gradle
  repositoryName: Account-Ledger-Android-Client

steps:
  - checkout: self
    submodules: recursive

  - task: Cache@2.198.0
    inputs:
      key: 'gradleUserHome | "$(Agent.OS)"'
      restoreKeys: gradleUserHome
      path: $(GRADLE_USER_HOME)
    displayName: Gradle User Home Cache

  - task: JavaToolInstaller@0.209.0
    inputs:
      versionSpec: "17"
      jdkArchitectureOption: "x64"
      jdkSourceOption: "PreInstalled"

  - script: |
      sed -i 's|https://nomadller.in|https://baneeishaque.helioho.st|' app/src/main/java/ndk/personal/account_ledger/constants/ServerEndpoint.java
      sed -i 's|http_api|GitHub_Banee-Ishaque_Account-Ledger-Server-PHP/http_API|' app/src/main/java/ndk/personal/account_ledger/constants/ServerEndpoint.java
    displayName: "Update ServerEndpoint constants"

  - task: Gradle@3.208.0
    displayName: "Gradle assembleProductionRelease : Android APK"
    inputs:
      # TODO : Add build scan, upload build scan results
      gradleOptions: "-Xmx3072m"
      tasks: "assembleProductionRelease"

  - script: "gradlew --stop"
    displayName: Stop Gradle Daemon

  - publish: app/build/outputs/apk/production/release/app-production-release.apk
    artifact: $(repositoryName) Release Apk
